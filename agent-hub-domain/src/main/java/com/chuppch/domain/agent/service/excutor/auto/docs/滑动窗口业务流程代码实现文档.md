# æ»‘åŠ¨çª—å£ä¸šåŠ¡æµç¨‹ä»£ç å®ç°æ–‡æ¡£

## ä¸€ã€æ¦‚è¿°

### 1.1 æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£æä¾›åœ¨ Auto Agent æ‰§è¡Œæµç¨‹ä¸­é›†æˆ `ExecutionHistoryManager` çš„å®Œæ•´ä»£ç å®ç°æŒ‡å—ï¼ŒåŒ…æ‹¬å„èŠ‚ç‚¹çš„ä¿®æ”¹ç‚¹ã€é›†æˆæ­¥éª¤å’Œä½¿ç”¨ç¤ºä¾‹ã€‚

### 1.2 æ ¸å¿ƒç›®æ ‡

- **æ›¿æ¢ StringBuilder**ï¼šå°†åŸæœ‰çš„ `StringBuilder executionHistory` æ›¿æ¢ä¸º `ExecutionHistoryManager`
- **è‡ªåŠ¨å‹ç¼©æœºåˆ¶**ï¼šåœ¨è¿½åŠ æ­¥éª¤æ—¶è‡ªåŠ¨è§¦å‘å‹ç¼©ï¼Œæ§åˆ¶å†å²è®°å½•é•¿åº¦
- **åˆ†å±‚å­˜å‚¨**ï¼šå®ç°è¯¦ç»†å±‚å’Œæ‘˜è¦å±‚çš„åˆ†å±‚ç®¡ç†
- **æœ€å°ä¾µå…¥æ€§**ï¼šå°½å¯èƒ½å‡å°‘å¯¹ç°æœ‰ä»£ç çš„ä¿®æ”¹

### 1.3 ä¸šåŠ¡æµç¨‹æ¦‚è§ˆ

```
åˆå§‹åŒ– ExecutionHistoryManager
   â†“
å¾ªç¯æ‰§è¡Œï¼ˆstep = 1 to maxSteps && !isCompletedï¼‰
   â†“
ç¬¬ä¸€é˜¶æ®µï¼šä»»åŠ¡åˆ†æï¼ˆè°ƒç”¨ getHistory()ï¼‰
   â†“
ç¬¬äºŒé˜¶æ®µï¼šç²¾å‡†æ‰§è¡Œ
   â†“
ç¬¬ä¸‰é˜¶æ®µï¼šè´¨é‡ç›‘ç£
   â†“
æ›´æ–°æ‰§è¡Œå†å²ï¼ˆè°ƒç”¨ appendStep()ï¼‰
   â†“
ç»§ç»­ä¸‹ä¸€è½®æ‰§è¡Œ
   â†“
å¾ªç¯ç»“æŸå¤„ç†ï¼ˆè°ƒç”¨ getHistory() ç”Ÿæˆæ€»ç»“æŠ¥å‘Šï¼‰
```

---

## äºŒã€æ•°æ®ç»“æ„ä¿®æ”¹

### 2.1 DynamicContext ä¿®æ”¹

**æ–‡ä»¶ä½ç½®ï¼š** `DefaultAutoAgentExecuteStrategyFactory.java`

**åŸä»£ç ï¼š**
```java
/** æ‰§è¡Œå†å²è®°å½•ï¼ˆç´¯ç§¯æ¯è½®çš„åˆ†æ/æ‰§è¡Œ/ç›‘ç£ç»“æœï¼‰ */
private StringBuilder executionHistory;
```

**ä¿®æ”¹åï¼š**
```java
/** æ‰§è¡Œå†å²è®°å½•ç®¡ç†å™¨ï¼ˆå®ç°æ»‘åŠ¨çª—å£å’Œåˆ†å±‚å­˜å‚¨ï¼‰ */
private ExecutionHistoryManager executionHistoryManager;
```

**å®Œæ•´ä¿®æ”¹ç¤ºä¾‹ï¼š**
```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public static class DynamicContext {
    /** å½“å‰æ‰§è¡Œæ­¥éª¤å· */
    private int step = 1;

    /** æœ€å¤§ä»»åŠ¡æ­¥éª¤æ•°ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰ */
    private int maxStep = 1;

    /** æ‰§è¡Œå†å²è®°å½•ç®¡ç†å™¨ï¼ˆå®ç°æ»‘åŠ¨çª—å£å’Œåˆ†å±‚å­˜å‚¨ï¼‰ */
    private ExecutionHistoryManager executionHistoryManager;

    /** å½“å‰ä»»åŠ¡æè¿°ï¼ˆæ ¹æ®è´¨é‡ç›‘ç£åé¦ˆåŠ¨æ€æ›´æ–°ï¼‰ */
    private String currentTask;

    /** ä»»åŠ¡å®Œæˆæ ‡å¿—ï¼ˆè´¨é‡æ£€æŸ¥é€šè¿‡åè®¾ç½®ä¸º trueï¼‰ */
    boolean isCompleted = false;

    /** AI å®¢æˆ·ç«¯é…ç½®æ˜ å°„è¡¨ï¼ˆkey=å®¢æˆ·ç«¯ç±»å‹ï¼Œvalue=é…ç½®ä¿¡æ¯ï¼‰ */
    private Map<String, AiAgentClientFlowConfigVO> aiAgentClientFlowConfigVOMap;

    /** åŠ¨æ€æ•°æ®å­˜å‚¨ï¼ˆç”¨äºèŠ‚ç‚¹é—´ä¼ é€’æ•°æ®ï¼Œå¦‚ emitterã€analysisResult ç­‰ï¼‰ */
    private Map<String, Object> dataObjects = new HashMap<>();

    // ... getter/setter æ–¹æ³•
}
```

---

## ä¸‰ã€å„èŠ‚ç‚¹é›†æˆä»£ç 

### 3.1 RootNode - åˆå§‹åŒ– ExecutionHistoryManager

**æ–‡ä»¶ä½ç½®ï¼š** `RootNode.java`

**åŸä»£ç ï¼š**
```java
// ä¸Šä¸‹æ–‡ä¿¡æ¯
dynamicContext.setExecutionHistory(new StringBuilder());
```

**ä¿®æ”¹åï¼š**
```java
// ä¸Šä¸‹æ–‡ä¿¡æ¯ - åˆå§‹åŒ–æ‰§è¡Œå†å²ç®¡ç†å™¨
dynamicContext.setExecutionHistoryManager(new ExecutionHistoryManager());
```

**å®Œæ•´ä»£ç ç¤ºä¾‹ï¼š**
```java
@Override
protected String doApply(ExecuteCommandEntity requestParameter, 
                         DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext) throws Exception {
    log.info("=== åŠ¨æ€å¤šè½®æ‰§è¡Œæµ‹è¯•å¼€å§‹ ====");
    log.info("ç”¨æˆ·è¾“å…¥: {}", requestParameter.getMessage());
    log.info("æœ€å¤§æ‰§è¡Œæ­¥æ•°: {}", requestParameter.getMaxStep());
    log.info("ä¼šè¯ID: {}", requestParameter.getSessionId());

    // è·å–æ™ºèƒ½ä½“-å®¢æˆ·ç«¯å…³è”è¡¨é…ç½®
    Map<String, AiAgentClientFlowConfigVO> aiAgentClientFlowConfigVOMap = 
        repository.queryAiAgentClientFlowConfig(requestParameter.getAiAgentId());

    // å®¢æˆ·ç«¯å¯¹è¯ç»„
    dynamicContext.setAiAgentClientFlowConfigVOMap(aiAgentClientFlowConfigVOMap);
    
    // ä¸Šä¸‹æ–‡ä¿¡æ¯ - åˆå§‹åŒ–æ‰§è¡Œå†å²ç®¡ç†å™¨
    dynamicContext.setExecutionHistoryManager(new ExecutionHistoryManager());
    
    // å½“å‰ä»»åŠ¡ä¿¡æ¯
    dynamicContext.setCurrentTask(requestParameter.getMessage());
    
    // æœ€å¤§ä»»åŠ¡æ­¥éª¤
    dynamicContext.setMaxStep(requestParameter.getMaxStep());

    return router(requestParameter, dynamicContext);
}
```

---

### 3.2 Step1AnalyzerNode - è·å–å†å²è®°å½•

**æ–‡ä»¶ä½ç½®ï¼š** `Step1AnalyzerNode.java`

**åŸä»£ç ï¼š**
```java
String analysisPrompt = String.format(aiAgentClientFlowConfigVO.getStepPrompt(),
        requestParameter.getMessage(),
        dynamicContext.getStep(),
        dynamicContext.getMaxStep(),
        !dynamicContext.getExecutionHistory().isEmpty() ? dynamicContext.getExecutionHistory().toString() : "[é¦–æ¬¡æ‰§è¡Œ]",
        dynamicContext.getCurrentTask()
);
```

**ä¿®æ”¹åï¼š**
```java
String analysisPrompt = String.format(aiAgentClientFlowConfigVO.getStepPrompt(),
        requestParameter.getMessage(),
        dynamicContext.getStep(),
        dynamicContext.getMaxStep(),
        dynamicContext.getExecutionHistoryManager().getHistory(),
        dynamicContext.getCurrentTask()
);
```

**è¯´æ˜ï¼š**
- `getHistory()` æ–¹æ³•å·²ç»å¤„ç†äº†é¦–æ¬¡æ‰§è¡Œçš„æƒ…å†µï¼Œä¼šè¿”å› `"[é¦–æ¬¡æ‰§è¡Œ]"`
- ä¸éœ€è¦é¢å¤–çš„ç©ºå€¼æ£€æŸ¥

**å®Œæ•´ä»£ç ç¤ºä¾‹ï¼š**
```java
@Override
protected String doApply(ExecuteCommandEntity requestParameter, 
                         DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext) throws Exception {
    log.info("\n === æ‰§è¡Œç¬¬ {} æ­¥ ===", dynamicContext.getStep());

    // æ ¹æ®å®¢æˆ·ç«¯ç±»å‹ - è·å–é…ç½®ä¿¡æ¯
    AiAgentClientFlowConfigVO aiAgentClientFlowConfigVO = 
        dynamicContext.getAiAgentClientFlowConfigVOMap()
            .get(AiClientTypeEnumVO.TASK_ANALYZER_CLIENT.getCode());

    // æ„å»ºä»»åŠ¡åˆ†ææç¤ºè¯
    log.info("\n é˜¶æ®µ1: ä»»åŠ¡çŠ¶æ€åˆ†æ");
    String analysisPrompt = String.format(aiAgentClientFlowConfigVO.getStepPrompt(),
            requestParameter.getMessage(),
            dynamicContext.getStep(),
            dynamicContext.getMaxStep(),
            dynamicContext.getExecutionHistoryManager().getHistory(),  // â† ä¿®æ”¹ç‚¹
            dynamicContext.getCurrentTask()
    );

    // è·å– AgentClient å®¢æˆ·ç«¯
    ChatClient chatClient = getChatClientByClientId(aiAgentClientFlowConfigVO.getClientId());

    // è°ƒç”¨å®¢æˆ·ç«¯æ‰§è¡Œ - è·å–åˆ†æç»“æœ
    String analysisResult = chatClient
            .prompt(analysisPrompt)
            .advisors(a -> a
                    .param(CHAT_MEMORY_CONVERSATION_ID_KEY, requestParameter.getSessionId())
                    .param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 1024))
            .call().content();

    assert analysisResult != null;

    // è§£æåˆ†æç»“æœ - æµå¼è¾“å‡ºç»™å‰ç«¯
    parseAnalysisResult(dynamicContext, analysisResult, requestParameter.getSessionId());

    // å°†åˆ†æç»“æœä¿å­˜åˆ°åŠ¨æ€ä¸Šä¸‹æ–‡ä¸­ï¼Œä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
    dynamicContext.setValue("analysisResult", analysisResult);

    // æ£€æŸ¥æ˜¯å¦å·²ç»å®Œæˆ
    if (analysisResult.contains("ä»»åŠ¡çŠ¶æ€: COMPLETED") ||
            analysisResult.contains("å®Œæˆåº¦è¯„ä¼°: 100%")) {
        dynamicContext.setCompleted(true);
        log.info("\n ä»»åŠ¡å·²å®Œæˆï¼Œä»»åŠ¡æè¿°: {}", dynamicContext.getCurrentTask());
    }

    return router(requestParameter, dynamicContext);
}
```

---

### 3.3 Step2PrecisionExecutorNode - ç§»é™¤å†å²è®°å½•è¿½åŠ 

**æ–‡ä»¶ä½ç½®ï¼š** `Step2PrecisionExecutorNode.java`

**åŸä»£ç ï¼š**
```java
// æ›´æ–°æ‰§è¡Œå†å²
String stepSummary = String.format("""
        === ç¬¬ %d æ­¥æ‰§è¡Œè®°å½• ===
        ã€åˆ†æé˜¶æ®µã€‘%s
        ã€æ‰§è¡Œé˜¶æ®µã€‘%s
        """, dynamicContext.getStep(), analysisResult, executionResult);

dynamicContext.getExecutionHistory().append(stepSummary);
```

**ä¿®æ”¹åï¼š**
```java
// æ³¨æ„ï¼šæ­¤é˜¶æ®µä¸è¿½åŠ å†å²è®°å½•
// å†å²è®°å½•å°†åœ¨ Step3QualitySupervisorNode ä¸­ç»Ÿä¸€è¿½åŠ ï¼ˆåŒ…å«å®Œæ•´çš„ä¸‰ä¸ªé˜¶æ®µç»“æœï¼‰
```

**è¯´æ˜ï¼š**
- `Step2PrecisionExecutorNode` åªå®Œæˆäº†åˆ†æé˜¶æ®µå’Œæ‰§è¡Œé˜¶æ®µ
- ç›‘ç£é˜¶æ®µçš„ç»“æœè¿˜æœªç”Ÿæˆï¼Œå› æ­¤ä¸åœ¨æ­¤å¤„è¿½åŠ å†å²è®°å½•
- å®Œæ•´çš„æ­¥éª¤è®°å½•ï¼ˆåŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼‰å°†åœ¨ `Step3QualitySupervisorNode` ä¸­ç»Ÿä¸€è¿½åŠ 

**å®Œæ•´ä»£ç ç¤ºä¾‹ï¼š**
```java
@Override
protected String doApply(ExecuteCommandEntity requestParameter, 
                         DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext) throws Exception {
    log.info("\n é˜¶æ®µ2: ç²¾å‡†ä»»åŠ¡æ‰§è¡Œ");

    // ä»åŠ¨æ€ä¸Šä¸‹æ–‡ä¸­è·å–åˆ†æç»“æœ
    String analysisResult = dynamicContext.getValue("analysisResult");
    if (analysisResult == null || analysisResult.isEmpty()) {
        log.warn(" åˆ†æç»“æœä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ‰§è¡Œç­–ç•¥");
        analysisResult = "æ‰§è¡Œå½“å‰ä»»åŠ¡æ­¥éª¤";
    }

    // è·å–å®¢æˆ·ç«¯é…ç½®
    AiAgentClientFlowConfigVO aiAgentClientFlowConfigVO = 
        dynamicContext.getAiAgentClientFlowConfigVOMap()
            .get(AiClientTypeEnumVO.PRECISION_EXECUTOR_CLIENT.getCode());

    // æ„å»ºæ‰§è¡Œæç¤ºè¯
    String executionPrompt = String.format(aiAgentClientFlowConfigVO.getStepPrompt(),
            requestParameter.getMessage(),
            analysisResult
    );

    // è·å– AgentClient å®¢æˆ·ç«¯
    ChatClient chatClient = getChatClientByClientId(aiAgentClientFlowConfigVO.getClientId());

    // è°ƒç”¨å®¢æˆ·ç«¯æ‰§è¡Œ - è·å–æ‰§è¡Œç»“æœ
    String executionResult = chatClient
            .prompt(executionPrompt)
            .advisors(a -> a
                    .param(CHAT_MEMORY_CONVERSATION_ID_KEY, requestParameter.getSessionId())
                    .param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 1024))
            .call().content();

    assert executionResult != null;

    parseExecutionResult(dynamicContext, executionResult, requestParameter.getSessionId());

    dynamicContext.setValue("executionResult", executionResult);

    // æ³¨æ„ï¼šå†å²è®°å½•å°†åœ¨ Step3QualitySupervisorNode ä¸­ç»Ÿä¸€è¿½åŠ 
    // å› ä¸ºæ­¤æ—¶ç›‘ç£é˜¶æ®µçš„ç»“æœè¿˜æœªç”Ÿæˆ

    return router(requestParameter, dynamicContext);
}
```

---

### 3.4 Step3QualitySupervisorNode - è¿½åŠ å®Œæ•´æ­¥éª¤è®°å½•

**æ–‡ä»¶ä½ç½®ï¼š** `Step3QualitySupervisorNode.java`

**åŸä»£ç ï¼š**
```java
// æ›´æ–°æ‰§è¡Œå†å²
String stepSummary = String.format("""
        === ç¬¬ %d æ­¥å®Œæ•´è®°å½• ===
        ã€åˆ†æé˜¶æ®µã€‘%s
        ã€æ‰§è¡Œé˜¶æ®µã€‘%s
        ã€ç›‘ç£é˜¶æ®µã€‘%s
        """, dynamicContext.getStep(),
        dynamicContext.getValue("analysisResult"),
        executionResult,
        supervisionResult);

dynamicContext.getExecutionHistory().append(stepSummary);
```

**ä¿®æ”¹åï¼š**
```java
// æ›´æ–°æ‰§è¡Œå†å² - è¿½åŠ å®Œæ•´çš„ä¸‰é˜¶æ®µç»“æœ
dynamicContext.getExecutionHistoryManager().appendStep(
        dynamicContext.getStep(),
        dynamicContext.getValue("analysisResult"),
        executionResult,
        supervisionResult
);
```

**è¯´æ˜ï¼š**
- è¿™æ˜¯**å”¯ä¸€**è¿½åŠ å†å²è®°å½•çš„åœ°æ–¹
- è¿½åŠ çš„æ˜¯å®Œæ•´çš„æ­¥éª¤è®°å½•ï¼ˆåŒ…å«åˆ†æã€æ‰§è¡Œã€ç›‘ç£ä¸‰ä¸ªé˜¶æ®µï¼‰
- `appendStep()` æ–¹æ³•ä¼šè‡ªåŠ¨è§¦å‘å‹ç¼©æ£€æŸ¥

**å®Œæ•´ä»£ç ç¤ºä¾‹ï¼š**
```java
@Override
protected String doApply(ExecuteCommandEntity requestParameter, 
                         DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext) throws Exception {
    log.info("\n é˜¶æ®µ3: è´¨é‡ç›‘ç£æ£€æŸ¥");

    // ä»åŠ¨æ€ä¸Šä¸‹æ–‡ä¸­è·å–æ‰§è¡Œç»“æœ
    String executionResult = dynamicContext.getValue("executionResult");
    if (executionResult == null || executionResult.trim().isEmpty()) {
        log.warn(" æ‰§è¡Œç»“æœä¸ºç©ºï¼Œè·³è¿‡è´¨é‡ç›‘ç£");
        return "è´¨é‡ç›‘ç£è·³è¿‡";
    }

    // è·å–å®¢æˆ·ç«¯é…ç½®
    AiAgentClientFlowConfigVO aiAgentClientFlowConfigVO = 
        dynamicContext.getAiAgentClientFlowConfigVOMap()
            .get(AiClientTypeEnumVO.QUALITY_SUPERVISOR_CLIENT.getCode());

    // æ„å»ºç›‘ç£æç¤ºè¯
    String supervisionPrompt = String.format(aiAgentClientFlowConfigVO.getStepPrompt(),
            requestParameter.getMessage(),
            executionResult);

    // è·å–å¯¹è¯å®¢æˆ·ç«¯
    ChatClient chatClient = getChatClientByClientId(aiAgentClientFlowConfigVO.getClientId());

    // è°ƒç”¨å®¢æˆ·ç«¯æ‰§è¡Œ - è·å–è´¨é‡æ£€æŸ¥ç»“æœ
    String supervisionResult = chatClient
            .prompt(supervisionPrompt)
            .advisors(a -> a
                    .param(CHAT_MEMORY_CONVERSATION_ID_KEY, requestParameter.getSessionId())
                    .param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 1024))
            .call().content();

    assert supervisionResult != null;
    parseSupervisionResult(dynamicContext, supervisionResult, requestParameter.getSessionId());

    // å°†ç›‘ç£ç»“æœä¿å­˜åˆ°åŠ¨æ€ä¸Šä¸‹æ–‡
    dynamicContext.setValue("supervisionResult", supervisionResult);

    // æ ¹æ®ç›‘ç£ç»“æœå†³å®šæ˜¯å¦éœ€è¦é‡æ–°æ‰§è¡Œ
    if (supervisionResult.contains(("æ˜¯å¦é€šè¿‡: FAIL"))) {
        log.info(" è´¨é‡æ£€æŸ¥æœªé€šè¿‡ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ");
        dynamicContext.setCurrentTask("æ ¹æ®è´¨é‡ç›‘ç£çš„å»ºè®®é‡æ–°æ‰§è¡Œä»»åŠ¡");
    } else if (supervisionResult.contains("æ˜¯å¦é€šè¿‡: OPTIMIZE")) {
        log.info(" è´¨é‡æ£€æŸ¥å»ºè®®ä¼˜åŒ–ï¼Œç»§ç»­æ”¹è¿›");
        dynamicContext.setCurrentTask("æ ¹æ®è´¨é‡ç›‘ç£çš„å»ºè®®ä¼˜åŒ–æ‰§è¡Œç»“æœ");
    } else {
        log.info(" è´¨é‡æ£€æŸ¥é€šè¿‡");
        dynamicContext.setCompleted(true);
    }

    // æ›´æ–°æ‰§è¡Œå†å² - è¿½åŠ å®Œæ•´çš„ä¸‰é˜¶æ®µç»“æœ
    dynamicContext.getExecutionHistoryManager().appendStep(
            dynamicContext.getStep(),
            dynamicContext.getValue("analysisResult"),
            executionResult,
            supervisionResult
    );

    // å¢åŠ æ­¥éª¤è®¡æ•°
    dynamicContext.setStep(dynamicContext.getStep() + 1);

    // å¦‚æœä»»åŠ¡å·²å®Œæˆæˆ–è¾¾åˆ°æœ€å¤§æ­¥æ•°ï¼Œè¿›å…¥æ€»ç»“é˜¶æ®µ
    if (dynamicContext.isCompleted() || dynamicContext.getStep() > dynamicContext.getMaxStep()) {
        return router(requestParameter, dynamicContext);
    }

    // å¦åˆ™è¿›è¡Œä¸‹ä¸€è½®æ‰§è¡Œï¼Œè¿”å›åˆ°Step1AnalyzerNode
    return router(requestParameter, dynamicContext);
}
```

---

### 3.5 Step4LogExecutionSummaryNode - è·å–å®Œæ•´å†å²è®°å½•

**æ–‡ä»¶ä½ç½®ï¼š** `Step4LogExecutionSummaryNode.java`

**åŸä»£ç ï¼š**
```java
// åœ¨ getSummaryPrompt æ–¹æ³•ä¸­
String summaryPrompt = String.format(aiAgentClientFlowConfigVO.getStepPrompt(),
        requestParameter.getMessage(),
        dynamicContext.getExecutionHistory().toString());
```

**ä¿®æ”¹åï¼š**
```java
// åœ¨ getSummaryPrompt æ–¹æ³•ä¸­
String summaryPrompt = String.format(aiAgentClientFlowConfigVO.getStepPrompt(),
        requestParameter.getMessage(),
        dynamicContext.getExecutionHistoryManager().getHistory());
```

**å®Œæ•´ä»£ç ç¤ºä¾‹ï¼š**
```java
@Override
protected String doApply(ExecuteCommandEntity requestParameter, 
                         DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext) throws Exception {
    log.info("\n === æ‰§è¡Œç¬¬ {} æ­¥ ===", dynamicContext.getStep());
    log.info("\n é˜¶æ®µ4: æ‰§è¡Œæ€»ç»“åˆ†æ");

    // è®°å½•æ‰§è¡Œæ€»ç»“
    logExecutionSummary(dynamicContext.getMaxStep(), 
                       dynamicContext.getExecutionHistoryManager(), 
                       dynamicContext.isCompleted());

    // ç”Ÿæˆæœ€ç»ˆæ€»ç»“æŠ¥å‘Šï¼ˆæ— è®ºä»»åŠ¡æ˜¯å¦å®Œæˆéƒ½éœ€è¦ç”Ÿæˆï¼‰
    generateFinalReport(requestParameter, dynamicContext);

    log.info("\n === åŠ¨æ€å¤šè½®æ‰§è¡Œç»“æŸ ====");

    return "ai agent execution summary completed!";
}

/**
 * ç”Ÿæˆæœ€ç»ˆæ€»ç»“æŠ¥å‘Š
 */
private void generateFinalReport(ExecuteCommandEntity requestParameter, 
                                 DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext) {
    try {
        boolean isCompleted = dynamicContext.isCompleted();
        log.info("\n--- ç”Ÿæˆ{}ä»»åŠ¡çš„æœ€ç»ˆç­”æ¡ˆ ---", isCompleted ? "å·²å®Œæˆ" : "æœªå®Œæˆ");

        AiAgentClientFlowConfigVO aiAgentClientFlowConfigVO = 
            dynamicContext.getAiAgentClientFlowConfigVOMap()
                .get(AiClientTypeEnumVO.RESPONSE_ASSISTANT.getCode());

        String summaryPrompt = getSummaryPrompt(aiAgentClientFlowConfigVO, 
                                                requestParameter, 
                                                dynamicContext, 
                                                isCompleted);

        // è·å–å¯¹è¯å®¢æˆ·ç«¯ - ä½¿ç”¨ä»»åŠ¡åˆ†æå®¢æˆ·ç«¯è¿›è¡Œæ€»ç»“
        ChatClient chatClient = getChatClientByClientId(aiAgentClientFlowConfigVO.getClientId());

        String summaryResult = chatClient
                .prompt(summaryPrompt)
                .advisors(a -> a
                        .param(CHAT_MEMORY_CONVERSATION_ID_KEY, requestParameter.getSessionId() + "-summary")
                        .param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 50))
                .call().content();

        assert summaryResult != null;
        logFinalReport(dynamicContext, summaryResult, requestParameter.getSessionId());

        // å°†æ€»ç»“ç»“æœä¿å­˜åˆ°åŠ¨æ€ä¸Šä¸‹æ–‡ä¸­
        dynamicContext.setValue("finalSummary", summaryResult);

    } catch (Exception e) {
        log.error("ç”Ÿæˆæœ€ç»ˆæ€»ç»“æŠ¥å‘Šæ—¶å‡ºç°å¼‚å¸¸: {}", e.getMessage(), e);
    }
}

private static String getSummaryPrompt(AiAgentClientFlowConfigVO aiAgentClientFlowConfigVO, 
                                       ExecuteCommandEntity requestParameter, 
                                       DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext, 
                                       boolean isCompleted) {
    String summaryPrompt;
    if (isCompleted) {
        summaryPrompt = String.format(aiAgentClientFlowConfigVO.getStepPrompt(),
                requestParameter.getMessage(),
                dynamicContext.getExecutionHistoryManager().getHistory());  // â† ä¿®æ”¹ç‚¹
    } else {
        summaryPrompt = String.format("""
                è™½ç„¶ä»»åŠ¡æœªå®Œå…¨æ‰§è¡Œå®Œæˆï¼Œä½†è¯·åŸºäºå·²æœ‰çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå°½åŠ›å›ç­”ç”¨æˆ·çš„åŸå§‹é—®é¢˜ï¼š
                
                **ç”¨æˆ·åŸå§‹é—®é¢˜:** %s
                
                **å·²æ‰§è¡Œçš„è¿‡ç¨‹å’Œè·å¾—çš„ä¿¡æ¯:**
                %s
                
                **è¦æ±‚:**
                1. åŸºäºå·²æœ‰ä¿¡æ¯ï¼Œå°½åŠ›å›ç­”ç”¨æˆ·çš„åŸå§‹é—®é¢˜
                2. å¦‚æœä¿¡æ¯ä¸è¶³ï¼Œè¯´æ˜å“ªäº›éƒ¨åˆ†æ— æ³•å®Œæˆå¹¶ç»™å‡ºåŸå› 
                3. æä¾›å·²èƒ½ç¡®å®šçš„éƒ¨åˆ†ç­”æ¡ˆ
                4. ç»™å‡ºå®Œæˆå‰©ä½™éƒ¨åˆ†çš„å…·ä½“å»ºè®®
                5. ä»¥MDè¯­æ³•çš„è¡¨æ ¼å½¢å¼ï¼Œä¼˜åŒ–å±•ç¤ºç»“æœæ•°æ®
                
                è¯·åŸºäºç°æœ‰ä¿¡æ¯ç»™å‡ºç”¨æˆ·é—®é¢˜çš„ç­”æ¡ˆï¼š
                """,
                requestParameter.getMessage(),
                dynamicContext.getExecutionHistoryManager().getHistory());  // â† ä¿®æ”¹ç‚¹
    }
    return summaryPrompt;
}

/**
 * è¾“å‡ºæ‰§è¡Œæ€»ç»“ä¿¡æ¯
 */
private void logExecutionSummary(int maxSteps, 
                                 ExecutionHistoryManager executionHistoryManager, 
                                 boolean isCompleted) {
    log.info("\nğŸ“Š === åŠ¨æ€å¤šè½®æ‰§è¡Œæ€»ç»“ ====");
    
    // æ³¨æ„ï¼šå¦‚æœéœ€è¦è·å–æ€»æ­¥æ•°ï¼Œå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼è·å–
    // å› ä¸º ExecutionHistoryManager ä¸æš´éœ² totalSteps å­—æ®µ
    // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´
    
    if (isCompleted) {
        log.info("âœ… ä»»åŠ¡å®ŒæˆçŠ¶æ€: å·²å®Œæˆ");
    } else {
        log.info("â¸ï¸ ä»»åŠ¡å®ŒæˆçŠ¶æ€: æœªå®Œæˆï¼ˆè¾¾åˆ°æœ€å¤§æ­¥æ•°é™åˆ¶ï¼‰");
    }
}
```

---

## å››ã€ä¿®æ”¹æ¸…å•

### 4.1 éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹ç‚¹ | ä¿®æ”¹ç±»å‹ |
|------|--------|----------|
| `DefaultAutoAgentExecuteStrategyFactory.java` | DynamicContext å­—æ®µç±»å‹ | å­—æ®µç±»å‹ä¿®æ”¹ |
| `RootNode.java` | åˆå§‹åŒ– ExecutionHistoryManager | æ–¹æ³•è°ƒç”¨ä¿®æ”¹ |
| `Step1AnalyzerNode.java` | è·å–å†å²è®°å½• | æ–¹æ³•è°ƒç”¨ä¿®æ”¹ |
| `Step2PrecisionExecutorNode.java` | ç§»é™¤å†å²è®°å½•è¿½åŠ  | ä»£ç åˆ é™¤ |
| `Step3QualitySupervisorNode.java` | è¿½åŠ å®Œæ•´æ­¥éª¤è®°å½• | æ–¹æ³•è°ƒç”¨ä¿®æ”¹ |
| `Step4LogExecutionSummaryNode.java` | è·å–å®Œæ•´å†å²è®°å½• | æ–¹æ³•è°ƒç”¨ä¿®æ”¹ |

### 4.2 è¯¦ç»†ä¿®æ”¹ç‚¹

#### ä¿®æ”¹ç‚¹ 1ï¼šDynamicContext å­—æ®µç±»å‹

**æ–‡ä»¶ï¼š** `DefaultAutoAgentExecuteStrategyFactory.java`

**ä½ç½®ï¼š** ç¬¬ 47 è¡Œ

**ä¿®æ”¹ï¼š**
```java
// åŸä»£ç 
private StringBuilder executionHistory;

// ä¿®æ”¹å
private ExecutionHistoryManager executionHistoryManager;
```

---

#### ä¿®æ”¹ç‚¹ 2ï¼šRootNode åˆå§‹åŒ–

**æ–‡ä»¶ï¼š** `RootNode.java`

**ä½ç½®ï¼š** ç¬¬ 36 è¡Œ

**ä¿®æ”¹ï¼š**
```java
// åŸä»£ç 
dynamicContext.setExecutionHistory(new StringBuilder());

// ä¿®æ”¹å
dynamicContext.setExecutionHistoryManager(new ExecutionHistoryManager());
```

---

#### ä¿®æ”¹ç‚¹ 3ï¼šStep1AnalyzerNode è·å–å†å²

**æ–‡ä»¶ï¼š** `Step1AnalyzerNode.java`

**ä½ç½®ï¼š** ç¬¬ 35 è¡Œ

**ä¿®æ”¹ï¼š**
```java
// åŸä»£ç 
!dynamicContext.getExecutionHistory().isEmpty() ? dynamicContext.getExecutionHistory().toString() : "[é¦–æ¬¡æ‰§è¡Œ]"

// ä¿®æ”¹å
dynamicContext.getExecutionHistoryManager().getHistory()
```

---

#### ä¿®æ”¹ç‚¹ 4ï¼šStep2PrecisionExecutorNode ç§»é™¤è¿½åŠ 

**æ–‡ä»¶ï¼š** `Step2PrecisionExecutorNode.java`

**ä½ç½®ï¼š** ç¬¬ 54-61 è¡Œ

**ä¿®æ”¹ï¼š**
```java
// åŸä»£ç ï¼ˆåˆ é™¤ï¼‰
// æ›´æ–°æ‰§è¡Œå†å²
String stepSummary = String.format("""
        === ç¬¬ %d æ­¥æ‰§è¡Œè®°å½• ===
        ã€åˆ†æé˜¶æ®µã€‘%s
        ã€æ‰§è¡Œé˜¶æ®µã€‘%s
        """, dynamicContext.getStep(), analysisResult, executionResult);

dynamicContext.getExecutionHistory().append(stepSummary);

// ä¿®æ”¹åï¼ˆæ·»åŠ æ³¨é‡Šè¯´æ˜ï¼‰
// æ³¨æ„ï¼šå†å²è®°å½•å°†åœ¨ Step3QualitySupervisorNode ä¸­ç»Ÿä¸€è¿½åŠ 
// å› ä¸ºæ­¤æ—¶ç›‘ç£é˜¶æ®µçš„ç»“æœè¿˜æœªç”Ÿæˆ
```

---

#### ä¿®æ”¹ç‚¹ 5ï¼šStep3QualitySupervisorNode è¿½åŠ æ­¥éª¤

**æ–‡ä»¶ï¼š** `Step3QualitySupervisorNode.java`

**ä½ç½®ï¼š** ç¬¬ 65-76 è¡Œ

**ä¿®æ”¹ï¼š**
```java
// åŸä»£ç 
// æ›´æ–°æ‰§è¡Œå†å²
String stepSummary = String.format("""
        === ç¬¬ %d æ­¥å®Œæ•´è®°å½• ===
        ã€åˆ†æé˜¶æ®µã€‘%s
        ã€æ‰§è¡Œé˜¶æ®µã€‘%s
        ã€ç›‘ç£é˜¶æ®µã€‘%s
        """, dynamicContext.getStep(),
        dynamicContext.getValue("analysisResult"),
        executionResult,
        supervisionResult);

dynamicContext.getExecutionHistory().append(stepSummary);

// ä¿®æ”¹å
// æ›´æ–°æ‰§è¡Œå†å² - è¿½åŠ å®Œæ•´çš„ä¸‰é˜¶æ®µç»“æœ
dynamicContext.getExecutionHistoryManager().appendStep(
        dynamicContext.getStep(),
        dynamicContext.getValue("analysisResult"),
        executionResult,
        supervisionResult
);
```

---

#### ä¿®æ”¹ç‚¹ 6ï¼šStep4LogExecutionSummaryNode è·å–å†å²

**æ–‡ä»¶ï¼š** `Step4LogExecutionSummaryNode.java`

**ä½ç½®ï¼š** ç¬¬ 99 è¡Œå’Œç¬¬ 119 è¡Œ

**ä¿®æ”¹ï¼š**
```java
// åŸä»£ç ï¼ˆä¸¤å¤„ï¼‰
dynamicContext.getExecutionHistory().toString()

// ä¿®æ”¹åï¼ˆä¸¤å¤„ï¼‰
dynamicContext.getExecutionHistoryManager().getHistory()
```

---

## äº”ã€é›†æˆæ­¥éª¤

### 5.1 æ­¥éª¤ 1ï¼šä¿®æ”¹ DynamicContext

1. æ‰“å¼€ `DefaultAutoAgentExecuteStrategyFactory.java`
2. æ‰¾åˆ° `DynamicContext` ç±»å®šä¹‰
3. å°† `StringBuilder executionHistory` æ”¹ä¸º `ExecutionHistoryManager executionHistoryManager`
4. æ›´æ–°å¯¹åº”çš„ getter/setter æ–¹æ³•ï¼ˆå¦‚æœä½¿ç”¨ Lombok çš„ @Dataï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰

### 5.2 æ­¥éª¤ 2ï¼šä¿®æ”¹ RootNode

1. æ‰“å¼€ `RootNode.java`
2. åœ¨ `doApply` æ–¹æ³•ä¸­æ‰¾åˆ°åˆå§‹åŒ– executionHistory çš„ä»£ç 
3. å°† `new StringBuilder()` æ”¹ä¸º `new ExecutionHistoryManager()`
4. æ›´æ–°æ–¹æ³•è°ƒç”¨ä¸º `setExecutionHistoryManager()`

### 5.3 æ­¥éª¤ 3ï¼šä¿®æ”¹ Step1AnalyzerNode

1. æ‰“å¼€ `Step1AnalyzerNode.java`
2. åœ¨æ„å»º `analysisPrompt` çš„åœ°æ–¹
3. å°†è·å–å†å²è®°å½•çš„ä»£ç æ”¹ä¸º `getExecutionHistoryManager().getHistory()`
4. ç§»é™¤åŸæœ‰çš„ç©ºå€¼æ£€æŸ¥é€»è¾‘

### 5.4 æ­¥éª¤ 4ï¼šä¿®æ”¹ Step2PrecisionExecutorNode

1. æ‰“å¼€ `Step2PrecisionExecutorNode.java`
2. æ‰¾åˆ°è¿½åŠ å†å²è®°å½•çš„ä»£ç ï¼ˆçº¦ç¬¬ 54-61 è¡Œï¼‰
3. **åˆ é™¤**è¿™æ®µä»£ç 
4. æ·»åŠ æ³¨é‡Šè¯´æ˜å†å²è®°å½•å°†åœ¨ Step3QualitySupervisorNode ä¸­ç»Ÿä¸€è¿½åŠ 

### 5.5 æ­¥éª¤ 5ï¼šä¿®æ”¹ Step3QualitySupervisorNode

1. æ‰“å¼€ `Step3QualitySupervisorNode.java`
2. æ‰¾åˆ°è¿½åŠ å†å²è®°å½•çš„ä»£ç ï¼ˆçº¦ç¬¬ 65-76 è¡Œï¼‰
3. å°† `String.format()` å’Œ `append()` è°ƒç”¨æ”¹ä¸º `appendStep()` æ–¹æ³•è°ƒç”¨
4. ä¼ å…¥å››ä¸ªå‚æ•°ï¼šstepã€analysisResultã€executionResultã€supervisionResult

### 5.6 æ­¥éª¤ 6ï¼šä¿®æ”¹ Step4LogExecutionSummaryNode

1. æ‰“å¼€ `Step4LogExecutionSummaryNode.java`
2. æ‰¾åˆ° `getSummaryPrompt` æ–¹æ³•
3. å°†ä¸¤å¤„ `getExecutionHistory().toString()` æ”¹ä¸º `getExecutionHistoryManager().getHistory()`
4. æ›´æ–° `logExecutionSummary` æ–¹æ³•çš„å‚æ•°ï¼ˆå¦‚æœéœ€è¦ï¼‰

### 5.7 æ­¥éª¤ 7ï¼šæ·»åŠ å¯¼å…¥è¯­å¥

åœ¨æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶ä¸­æ·»åŠ å¯¼å…¥è¯­å¥ï¼š

```java
import com.chuppch.domain.agent.service.excutor.auto.VO.ExecutionHistoryManager;
```

---

## å…­ã€æ³¨æ„äº‹é¡¹

### 6.1 å…³é”®æ³¨æ„äº‹é¡¹

1. **å”¯ä¸€è¿½åŠ ç‚¹**ï¼šå†å²è®°å½•åªåœ¨ `Step3QualitySupervisorNode` ä¸­è¿½åŠ ï¼Œä¸è¦åœ¨ `Step2PrecisionExecutorNode` ä¸­è¿½åŠ 
2. **é¦–æ¬¡æ‰§è¡Œå¤„ç†**ï¼š`getHistory()` æ–¹æ³•å·²ç»å¤„ç†äº†é¦–æ¬¡æ‰§è¡Œçš„æƒ…å†µï¼Œè¿”å› `"[é¦–æ¬¡æ‰§è¡Œ]"`
3. **è‡ªåŠ¨å‹ç¼©**ï¼š`appendStep()` æ–¹æ³•ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶è§¦å‘å‹ç¼©ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
4. **çº¿ç¨‹å®‰å…¨**ï¼š`ExecutionHistoryManager` ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç¡®ä¿åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨

### 6.2 å…¼å®¹æ€§è¯´æ˜

- **å‘åå…¼å®¹**ï¼šä¿®æ”¹åä¸å½±å“ç°æœ‰çš„ä¸šåŠ¡é€»è¾‘
- **æ•°æ®æ ¼å¼**ï¼š`getHistory()` è¿”å›çš„æ ¼å¼ä¸åŸæ¥çš„ `StringBuilder.toString()` ç±»ä¼¼ï¼Œä½†åŒ…å«æ‘˜è¦å±‚
- **æ€§èƒ½å½±å“**ï¼šé¢„è®¡å¯ä»¥å‡å°‘ 50-70% çš„ token æ¶ˆè€—

### 6.3 æµ‹è¯•å»ºè®®

1. **å•å…ƒæµ‹è¯•**ï¼šæµ‹è¯•å„èŠ‚ç‚¹çš„ä¿®æ”¹æ˜¯å¦æ­£ç¡®
2. **é›†æˆæµ‹è¯•**ï¼šæµ‹è¯•å®Œæ•´çš„æ‰§è¡Œæµç¨‹
3. **è¾¹ç•Œæµ‹è¯•**ï¼šæµ‹è¯•é¦–æ¬¡æ‰§è¡Œã€å•æ­¥æ‰§è¡Œã€å¤§é‡æ­¥æ•°æ‰§è¡Œçš„æƒ…å†µ
4. **å‹ç¼©æµ‹è¯•**ï¼šéªŒè¯å‹ç¼©æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

## ä¸ƒã€å®Œæ•´ä»£ç ç¤ºä¾‹

### 7.1 ä¿®æ”¹åçš„å®Œæ•´æµç¨‹ç¤ºä¾‹

```java
// ========== RootNode.java ==========
@Override
protected String doApply(ExecuteCommandEntity requestParameter, 
                         DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext) throws Exception {
    // ... å…¶ä»–ä»£ç  ...
    
    // åˆå§‹åŒ–æ‰§è¡Œå†å²ç®¡ç†å™¨
    dynamicContext.setExecutionHistoryManager(new ExecutionHistoryManager());
    
    // ... å…¶ä»–ä»£ç  ...
}

// ========== Step1AnalyzerNode.java ==========
@Override
protected String doApply(ExecuteCommandEntity requestParameter, 
                         DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext) throws Exception {
    // ... å…¶ä»–ä»£ç  ...
    
    // è·å–å†å²è®°å½•ï¼ˆè‡ªåŠ¨å¤„ç†é¦–æ¬¡æ‰§è¡Œï¼‰
    String history = dynamicContext.getExecutionHistoryManager().getHistory();
    
    // æ„å»ºåˆ†æå™¨æç¤ºè¯
    String analysisPrompt = String.format(aiAgentClientFlowConfigVO.getStepPrompt(),
            requestParameter.getMessage(),
            dynamicContext.getStep(),
            dynamicContext.getMaxStep(),
            history,  // ä½¿ç”¨è·å–çš„å†å²è®°å½•
            dynamicContext.getCurrentTask()
    );
    
    // ... å…¶ä»–ä»£ç  ...
}

// ========== Step2PrecisionExecutorNode.java ==========
@Override
protected String doApply(ExecuteCommandEntity requestParameter, 
                         DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext) throws Exception {
    // ... æ‰§è¡Œé€»è¾‘ ...
    
    // æ³¨æ„ï¼šä¸åœ¨æ­¤å¤„è¿½åŠ å†å²è®°å½•
    // å†å²è®°å½•å°†åœ¨ Step3QualitySupervisorNode ä¸­ç»Ÿä¸€è¿½åŠ 
    
    // ... å…¶ä»–ä»£ç  ...
}

// ========== Step3QualitySupervisorNode.java ==========
@Override
protected String doApply(ExecuteCommandEntity requestParameter, 
                         DefaultAutoAgentExecuteStrategyFactory.DynamicContext dynamicContext) throws Exception {
    // ... ç›‘ç£é€»è¾‘ ...
    
    // æ›´æ–°æ‰§è¡Œå†å² - è¿½åŠ å®Œæ•´çš„ä¸‰é˜¶æ®µç»“æœ
    dynamicContext.getExecutionHistoryManager().appendStep(
            dynamicContext.getStep(),
            dynamicContext.getValue("analysisResult"),
            executionResult,
            supervisionResult
    );
    
    // ... å…¶ä»–ä»£ç  ...
}

// ========== Step4LogExecutionSummaryNode.java ==========
private static String getSummaryPrompt(..., boolean isCompleted) {
    if (isCompleted) {
        summaryPrompt = String.format(aiAgentClientFlowConfigVO.getStepPrompt(),
                requestParameter.getMessage(),
                dynamicContext.getExecutionHistoryManager().getHistory());
    } else {
        summaryPrompt = String.format("""
                ... æç¤ºè¯å†…å®¹ ...
                %s
                """,
                requestParameter.getMessage(),
                dynamicContext.getExecutionHistoryManager().getHistory());
    }
    return summaryPrompt;
}
```

---

## å…«ã€éªŒè¯æ¸…å•

### 8.1 ä»£ç ä¿®æ”¹éªŒè¯

- [ ] DynamicContext å­—æ®µç±»å‹å·²ä¿®æ”¹
- [ ] RootNode åˆå§‹åŒ–ä»£ç å·²ä¿®æ”¹
- [ ] Step1AnalyzerNode è·å–å†å²ä»£ç å·²ä¿®æ”¹
- [ ] Step2PrecisionExecutorNode å†å²è¿½åŠ ä»£ç å·²åˆ é™¤
- [ ] Step3QualitySupervisorNode å†å²è¿½åŠ ä»£ç å·²ä¿®æ”¹
- [ ] Step4LogExecutionSummaryNode è·å–å†å²ä»£ç å·²ä¿®æ”¹
- [ ] æ‰€æœ‰æ–‡ä»¶çš„å¯¼å…¥è¯­å¥å·²æ·»åŠ 

### 8.2 åŠŸèƒ½éªŒè¯

- [ ] é¦–æ¬¡æ‰§è¡Œæ—¶è¿”å› "[é¦–æ¬¡æ‰§è¡Œ]"
- [ ] å†å²è®°å½•æ­£ç¡®è¿½åŠ 
- [ ] å‹ç¼©æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] æ‘˜è¦å±‚æ­£ç¡®ç”Ÿæˆ
- [ ] æœ€ç»ˆæ€»ç»“æŠ¥å‘Šæ­£ç¡®ç”Ÿæˆ

### 8.3 æ€§èƒ½éªŒè¯

- [ ] Token æ¶ˆè€—æ˜æ˜¾å‡å°‘
- [ ] ä¸Šä¸‹æ–‡çª—å£æœªæº¢å‡º
- [ ] æ‰§è¡Œæ•ˆç‡æœªé™ä½

---

## ä¹ã€å¸¸è§é—®é¢˜

### 9.1 Q: ä¸ºä»€ä¹ˆä¸åœ¨ Step2PrecisionExecutorNode ä¸­è¿½åŠ å†å²è®°å½•ï¼Ÿ

**A:** å› ä¸ºæ­¤æ—¶ç›‘ç£é˜¶æ®µçš„ç»“æœè¿˜æœªç”Ÿæˆï¼Œå®Œæ•´çš„æ­¥éª¤è®°å½•åº”è¯¥åŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼ˆåˆ†æã€æ‰§è¡Œã€ç›‘ç£ï¼‰çš„ç»“æœã€‚åœ¨ `Step3QualitySupervisorNode` ä¸­ç»Ÿä¸€è¿½åŠ å¯ä»¥ç¡®ä¿è®°å½•å®Œæ•´æ€§ã€‚

### 9.2 Q: getHistory() æ–¹æ³•è¿”å›çš„æ ¼å¼æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** `getHistory()` è¿”å›çš„æ ¼å¼æ˜¯ï¼š
- æ‘˜è¦å±‚ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š`æ­¥éª¤X-Yæ‰§è¡Œæ‘˜è¦: ...`
- è¯¦ç»†å±‚ï¼š`=== ç¬¬ N æ­¥å®Œæ•´è®°å½• === ...`
- é¦–æ¬¡æ‰§è¡Œï¼š`"[é¦–æ¬¡æ‰§è¡Œ]"`

### 9.3 Q: å‹ç¼©æ˜¯è‡ªåŠ¨è§¦å‘çš„å—ï¼Ÿ

**A:** æ˜¯çš„ï¼Œ`appendStep()` æ–¹æ³•ä¼šè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼©ï¼Œå¦‚æœ `recentDetailedHistory.size() > windowSize`ï¼Œä¼šè‡ªåŠ¨è§¦å‘ `compressHistory()` æ–¹æ³•ã€‚

### 9.4 Q: å¦‚ä½•è°ƒæ•´çª—å£å¤§å°ï¼Ÿ

**A:** çª—å£å¤§å°ä¼šæ ¹æ®æ€»æ­¥æ•°åŠ¨æ€è°ƒæ•´ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°è‡ªå®šä¹‰ï¼š
```java
ExecutionHistoryManager manager = new ExecutionHistoryManager(
    10,  // windowSize
    5,   // compressionBatchSize
    5000 // maxSummaryLength
);
```

---

## åã€æ€»ç»“

### 10.1 æ ¸å¿ƒè¦ç‚¹

1. **æœ€å°ä¾µå…¥æ€§**ï¼šåªä¿®æ”¹å¿…è¦çš„ä»£ç ï¼Œä¿æŒåŸæœ‰ä¸šåŠ¡é€»è¾‘ä¸å˜
2. **è‡ªåŠ¨å‹ç¼©**ï¼šå‹ç¼©æœºåˆ¶è‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
3. **ç»Ÿä¸€è¿½åŠ **ï¼šå†å²è®°å½•åªåœ¨ `Step3QualitySupervisorNode` ä¸­ç»Ÿä¸€è¿½åŠ 
4. **æ ¼å¼å…¼å®¹**ï¼š`getHistory()` è¿”å›çš„æ ¼å¼ä¸åŸæœ‰æ ¼å¼å…¼å®¹

### 10.2 é¢„æœŸæ•ˆæœ

- **Token æ¶ˆè€—å‡å°‘**ï¼šé¢„è®¡å‡å°‘ 50-70%
- **ä¸Šä¸‹æ–‡çª—å£æ§åˆ¶**ï¼šé¿å…ä¸Šä¸‹æ–‡çª—å£æº¢å‡º
- **æ€§èƒ½æå‡**ï¼šå‡å°‘ä¸å¿…è¦çš„ token ä¼ è¾“å’Œå¤„ç†

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2025-01-03  
**ä½œè€…ï¼š** Chuppch

