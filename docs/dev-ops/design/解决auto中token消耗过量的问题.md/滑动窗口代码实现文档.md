# ExecutionHistoryManager ä»£ç å®ç°æ–‡æ¡£

## ä¸€ã€æ¦‚è¿°

### 1.1 æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£æä¾› `ExecutionHistoryManager` ç±»çš„å®Œæ•´ä»£ç å®ç°æŒ‡å—ï¼ŒåŒ…æ‹¬ç±»ç»“æ„ã€æ–¹æ³•å®ç°ã€æ•°æ®ç»“æ„å®šä¹‰å’Œä½¿ç”¨ç¤ºä¾‹ã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½

- **æ»‘åŠ¨çª—å£æœºåˆ¶**ï¼šåªä¿ç•™æœ€è¿‘ N æ­¥çš„å®Œæ•´è®°å½•
- **åˆ†å±‚å­˜å‚¨**ï¼šè¯¦ç»†å±‚ï¼ˆrecentDetailedHistoryï¼‰+ æ‘˜è¦å±‚ï¼ˆsummaryHistoryï¼‰
- **è‡ªåŠ¨å‹ç¼©**ï¼šè¶…è¿‡çª—å£å¤§å°æ—¶è‡ªåŠ¨å‹ç¼©æœ€æ—§çš„è®°å½•
- **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®æ€»æ­¥æ•°åŠ¨æ€è°ƒæ•´çª—å£å¤§å°å’Œå‹ç¼©æ‰¹æ¬¡å¤§å°

### 1.3 è®¾è®¡åŸåˆ™

- **ä½ä¾µå…¥æ€§**ï¼šæœ€å°åŒ–å¯¹ç°æœ‰ä»£ç çš„ä¿®æ”¹
- **å°è£…æ€§**ï¼šå†…éƒ¨å®ç°å¯¹å¤–é€æ˜
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘ token æ¶ˆè€—ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡

---

## äºŒã€ç±»ç»“æ„è®¾è®¡

### 2.1 ExecutionHistoryManager ç±»

```java
package com.chuppch.domain.agent.service.executor.auto.history;

import java.util.*;

/**
 * æ‰§è¡Œå†å²è®°å½•ç®¡ç†å™¨
 * 
 * æ ¸å¿ƒèŒè´£ï¼š
 * 1. ç®¡ç†æ‰§è¡Œå†å²è®°å½•ï¼ˆè¯¦ç»†å±‚ + æ‘˜è¦å±‚ï¼‰
 * 2. å®ç°æ»‘åŠ¨çª—å£æœºåˆ¶ï¼Œæ§åˆ¶å†å²è®°å½•é•¿åº¦
 * 3. è‡ªåŠ¨å‹ç¼©å†å²è®°å½•ï¼Œç”Ÿæˆæ‘˜è¦
 * 4. æ ¹æ®éœ€æ±‚æä¾›ä¸åŒç²’åº¦çš„å†å²ä¿¡æ¯
 */
public class ExecutionHistoryManager {
    
    // ========== å­—æ®µå®šä¹‰ ==========
    
    /** æœ€è¿‘è¯¦ç»†è®°å½•ï¼ˆæ»‘åŠ¨çª—å£çš„è¯¦ç»†å±‚ï¼‰ */
    private final Deque<StepRecord> recentDetailedHistory;
    
    /** æ‘˜è¦å†å²ï¼ˆå‹ç¼©åçš„å†å²ï¼‰ */
    private final List<SummaryRecord> summaryHistory;
    
    /** çª—å£å¤§å°ï¼ˆæ§åˆ¶è¯¦ç»†å±‚ä¿ç•™å¤šå°‘æ­¥çš„å®Œæ•´è®°å½•ï¼‰ */
    private int windowSize;
    
    /** å‹ç¼©æ‰¹æ¬¡å¤§å°ï¼ˆæ¯æ¬¡å‹ç¼©æ—¶å¤„ç†å¤šå°‘æ­¥çš„è®°å½•ï¼‰ */
    private int compressionBatchSize;
    
    /** æ€»æ­¥æ•° */
    private int totalSteps;
    
    /** æœ€å¤§æ‘˜è¦é•¿åº¦ï¼ˆé¿å…æ‘˜è¦ä¹Ÿæ— é™å¢é•¿ï¼‰ */
    private final int maxSummaryLength;
    
    // ========== å¸¸é‡å®šä¹‰ ==========
    
    /** é»˜è®¤çª—å£å¤§å° */
    private static final int DEFAULT_WINDOW_SIZE = 5;
    
    /** é»˜è®¤å‹ç¼©æ‰¹æ¬¡å¤§å° */
    private static final int DEFAULT_COMPRESSION_BATCH_SIZE = 3;
    
    /** é»˜è®¤æœ€å¤§æ‘˜è¦é•¿åº¦ */
    private static final int DEFAULT_MAX_SUMMARY_LENGTH = 5000;
    
    /** å­—æ®µæå–æ—¶çš„æœ€å¤§é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰ */
    private static final int MAX_FIELD_LENGTH = 200;
    
    // ========== æ„é€ å‡½æ•° ==========
    
    /**
     * é»˜è®¤æ„é€ å‡½æ•°
     */
    public ExecutionHistoryManager() {
        this.recentDetailedHistory = new ArrayDeque<>();
        this.summaryHistory = new ArrayList<>();
        this.windowSize = DEFAULT_WINDOW_SIZE;
        this.compressionBatchSize = DEFAULT_COMPRESSION_BATCH_SIZE;
        this.totalSteps = 0;
        this.maxSummaryLength = DEFAULT_MAX_SUMMARY_LENGTH;
    }
    
    /**
     * å¸¦å‚æ•°çš„æ„é€ å‡½æ•°
     * 
     * @param windowSize çª—å£å¤§å°
     * @param compressionBatchSize å‹ç¼©æ‰¹æ¬¡å¤§å°
     * @param maxSummaryLength æœ€å¤§æ‘˜è¦é•¿åº¦
     */
    public ExecutionHistoryManager(int windowSize, int compressionBatchSize, int maxSummaryLength) {
        this.recentDetailedHistory = new ArrayDeque<>();
        this.summaryHistory = new ArrayList<>();
        this.windowSize = windowSize;
        this.compressionBatchSize = compressionBatchSize;
        this.totalSteps = 0;
        this.maxSummaryLength = maxSummaryLength;
    }
}
```

---

## ä¸‰ã€æ ¸å¿ƒæ–¹æ³•å®ç°

### 3.1 appendStep æ–¹æ³•

```java
/**
 * è¿½åŠ æ–°æ­¥éª¤
 * 
 * @param stepNumber æ­¥æ•°
 * @param analysisResult åˆ†æé˜¶æ®µçš„ç»“æœ
 * @param executionResult æ‰§è¡Œé˜¶æ®µçš„ç»“æœ
 * @param supervisionResult ç›‘ç£é˜¶æ®µçš„ç»“æœ
 */
public void appendStep(int stepNumber, String analysisResult, String executionResult, String supervisionResult) {
    // ========== æ­¥éª¤ a: åˆ›å»º StepRecord å¯¹è±¡ ==========
    StepRecord record = new StepRecord();
    record.setStepNumber(stepNumber);
    record.setAnalysisResult(analysisResult);
    record.setExecutionResult(executionResult);
    record.setSupervisionResult(supervisionResult);
    record.setTimestamp(System.currentTimeMillis());
    
    // æ ¼å¼åŒ–å®Œæ•´è®°å½•ï¼ˆç”¨äº getHistory() æ–¹æ³•ï¼‰
    String stepSummary = String.format("""
        === ç¬¬ %d æ­¥å®Œæ•´è®°å½• ===
        ã€åˆ†æé˜¶æ®µã€‘%s
        ã€æ‰§è¡Œé˜¶æ®µã€‘%s
        ã€ç›‘ç£é˜¶æ®µã€‘%s
        """, stepNumber, analysisResult, executionResult, supervisionResult);
    record.setStepSummary(stepSummary);
    
    // ========== æ­¥éª¤ b: è¿½åŠ åˆ° recentDetailedHistory ==========
    recentDetailedHistory.addLast(record);
    
    // ========== æ­¥éª¤ c: é€’å¢ totalSteps ==========
    totalSteps++;
    
    // ========== æ­¥éª¤ d: åŠ¨æ€è°ƒæ•´ windowSize å’Œ compressionBatchSize ==========
    adjustWindowSizeAndBatchSize();
    
    // ========== æ­¥éª¤ e: æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼© ==========
    if (shouldCompress()) {
        // ========== æ­¥éª¤ f: è‡ªåŠ¨è§¦å‘å‹ç¼© ==========
        compressHistory();
    }
}
```

---

### 3.2 getHistory æ–¹æ³•

```java
/**
 * è·å–å®Œæ•´çš„å†å²è®°å½•ï¼ˆæ‘˜è¦ + è¯¦ç»†è®°å½•ï¼‰
 * 
 * @return æ ¼å¼åŒ–çš„å†å²è®°å½•å­—ç¬¦ä¸²
 */
public String getHistory() {
    // å¦‚æœæ²¡æœ‰ä»»ä½•å†å²è®°å½•ï¼Œè¿”å›é¦–æ¬¡æ‰§è¡Œæ ‡è¯†
    if (summaryHistory.isEmpty() && recentDetailedHistory.isEmpty()) {
        return "[é¦–æ¬¡æ‰§è¡Œ]";
    }
    
    StringBuilder historyBuilder = new StringBuilder();
    
    // ========== æ ¼å¼åŒ–æ‘˜è¦å†å² ==========
    if (!summaryHistory.isEmpty()) {
        for (SummaryRecord summaryRecord : summaryHistory) {
            historyBuilder.append(summaryRecord.getSummary()).append("\n\n");
        }
    }
    
    // ========== æ ¼å¼åŒ–è¯¦ç»†å†å² ==========
    if (!recentDetailedHistory.isEmpty()) {
        for (StepRecord record : recentDetailedHistory) {
            historyBuilder.append(record.getStepSummary()).append("\n");
        }
    }
    
    return historyBuilder.toString().trim();
}
```

---

### 3.3 compressHistory æ–¹æ³•

```java
/**
 * å‹ç¼©å†å²è®°å½•
 * å°†è¯¦ç»†å±‚ä¸­æœ€æ—§çš„è®°å½•å‹ç¼©ä¸ºæ‘˜è¦ï¼Œç§»åˆ°æ‘˜è¦å±‚
 */
private void compressHistory() {
    // ========== æ­¥éª¤1: å–å‡ºéœ€è¦å‹ç¼©çš„è®°å½• ==========
    // ç¡®å®šå®é™…è¦å‹ç¼©çš„è®°å½•æ•°é‡ï¼ˆå¯èƒ½ä¸è¶³ compressionBatchSizeï¼‰
    int numRecordsToCompress = Math.min(compressionBatchSize, recentDetailedHistory.size());
    
    if (numRecordsToCompress == 0) {
        return;  // æ²¡æœ‰è®°å½•éœ€è¦å‹ç¼©
    }
    
    // ä»å¤´éƒ¨å–å‡ºæœ€æ—§çš„ N æ¡è®°å½•
    List<StepRecord> recordsToCompress = new ArrayList<>();
    for (int i = 0; i < numRecordsToCompress; i++) {
        StepRecord record = recentDetailedHistory.removeFirst();  // ä»å¤´éƒ¨ç§»é™¤
        recordsToCompress.add(record);
    }
    
    // è®°å½•èµ·å§‹å’Œç»“æŸæ­¥æ•°
    int startStep = recordsToCompress.get(0).getStepNumber();
    int endStep = recordsToCompress.get(recordsToCompress.size() - 1).getStepNumber();
    
    // ========== æ­¥éª¤2: æå–å…³é”®ä¿¡æ¯ ==========
    List<String> keyInfoList = new ArrayList<>();
    for (StepRecord record : recordsToCompress) {
        String keyInfo = extractKeyInfo(record);
        keyInfoList.add(keyInfo);
    }
    
    // ========== æ­¥éª¤3: ç”Ÿæˆæ‘˜è¦ ==========
    // æ ¼å¼åŒ–å¤šæ¡è®°å½•çš„å…³é”®ä¿¡æ¯
    StringBuilder summaryBuilder = new StringBuilder();
    summaryBuilder.append(String.format("æ­¥éª¤%d-%dæ‰§è¡Œæ‘˜è¦:\n", startStep, endStep));
    for (String keyInfo : keyInfoList) {
        summaryBuilder.append(keyInfo).append("\n\n");
    }
    String summary = summaryBuilder.toString().trim();
    
    // åˆ›å»º SummaryRecord å¯¹è±¡
    SummaryRecord summaryRecord = new SummaryRecord();
    summaryRecord.setStartStep(startStep);
    summaryRecord.setEndStep(endStep);
    summaryRecord.setSummary(summary);
    summaryRecord.setTimestamp(System.currentTimeMillis());
    
    // ========== æ­¥éª¤4: è¿½åŠ åˆ°æ‘˜è¦å±‚ ==========
    summaryHistory.add(summaryRecord);
    
    // ========== æ­¥éª¤5: ä»è¯¦ç»†å±‚ç§»é™¤è®°å½• ==========
    // å·²ç»åœ¨æ­¥éª¤1ä¸­ç§»é™¤äº†ï¼Œè¿™é‡Œä¸éœ€è¦å†æ¬¡ç§»é™¤
    
    // ========== æ­¥éª¤6: æ£€æŸ¥æ‘˜è¦å±‚é•¿åº¦ ==========
    checkAndCompressSummaryHistory();
}
```

---

### 3.4 extractKeyInfo æ–¹æ³•

```java
/**
 * ä»æ­¥éª¤è®°å½•ä¸­æå–å…³é”®ä¿¡æ¯
 * 
 * @param record æ­¥éª¤è®°å½•
 * @return æ ¼å¼åŒ–çš„å…³é”®ä¿¡æ¯å­—ç¬¦ä¸²
 */
private String extractKeyInfo(StepRecord record) {
    StringBuilder keyInfo = new StringBuilder();
    keyInfo.append(String.format("æ­¥éª¤%d:\n", record.getStepNumber()));
    
    // ========== ä» analysisResult ä¸­æå– ==========
    // æå–ä»»åŠ¡çŠ¶æ€
    String taskStatus = extractField(record.getAnalysisResult(), "**ä»»åŠ¡çŠ¶æ€:**");
    if (taskStatus != null && !taskStatus.isEmpty()) {
        keyInfo.append("  ä»»åŠ¡çŠ¶æ€: ").append(taskStatus.trim()).append("\n");
    } else {
        keyInfo.append("  ä»»åŠ¡çŠ¶æ€: æœªæä¾›\n");
    }
    
    // æå–å®Œæˆåº¦è¯„ä¼°
    String progress = extractField(record.getAnalysisResult(), "**å®Œæˆåº¦è¯„ä¼°:**");
    if (progress != null && !progress.isEmpty()) {
        keyInfo.append("  å®Œæˆåº¦: ").append(progress.trim()).append("\n");
    } else {
        keyInfo.append("  å®Œæˆåº¦: æœªæä¾›\n");
    }
    
    // ========== ä» executionResult ä¸­æå– ==========
    // æå–æ‰§è¡Œç›®æ ‡ï¼ˆæ‘˜è¦ï¼Œå¯èƒ½æˆªæ–­ï¼‰
    String executionTarget = extractField(record.getExecutionResult(), "**æ‰§è¡Œç›®æ ‡:**");
    if (executionTarget != null && !executionTarget.isEmpty()) {
        // æˆªæ–­åˆ°å‰ MAX_FIELD_LENGTH å­—ç¬¦
        String targetSummary = truncate(executionTarget, MAX_FIELD_LENGTH);
        keyInfo.append("  æ‰§è¡Œç›®æ ‡: ").append(targetSummary).append("\n");
    } else {
        keyInfo.append("  æ‰§è¡Œç›®æ ‡: æœªæä¾›\n");
    }
    
    // æå–å…³é”®ç»“æœï¼ˆæ‘˜è¦ï¼Œå¯èƒ½æˆªæ–­ï¼‰
    String executionResult = extractField(record.getExecutionResult(), "**æ‰§è¡Œç»“æœ:**");
    if (executionResult != null && !executionResult.isEmpty()) {
        // æˆªæ–­åˆ°å‰ MAX_FIELD_LENGTH å­—ç¬¦
        String resultSummary = truncate(executionResult, MAX_FIELD_LENGTH);
        keyInfo.append("  å…³é”®ç»“æœ: ").append(resultSummary).append("\n");
    } else {
        keyInfo.append("  å…³é”®ç»“æœ: æœªæä¾›\n");
    }
    
    // ========== ä» supervisionResult ä¸­æå– ==========
    // æå–è´¨é‡è¯„åˆ†
    String qualityScore = extractField(record.getSupervisionResult(), "**è´¨é‡è¯„åˆ†:**");
    if (qualityScore != null && !qualityScore.isEmpty()) {
        keyInfo.append("  è´¨é‡è¯„åˆ†: ").append(qualityScore.trim()).append("\n");
    } else {
        keyInfo.append("  è´¨é‡è¯„åˆ†: æœªæä¾›\n");
    }
    
    // æå–æ˜¯å¦é€šè¿‡
    String passStatus = extractField(record.getSupervisionResult(), "**æ˜¯å¦é€šè¿‡:**");
    if (passStatus != null && !passStatus.isEmpty()) {
        keyInfo.append("  æ˜¯å¦é€šè¿‡: ").append(passStatus.trim()).append("\n");
    } else {
        keyInfo.append("  æ˜¯å¦é€šè¿‡: æœªæä¾›\n");
    }
    
    return keyInfo.toString();
}
```

---

### 3.5 è¾…åŠ©æ–¹æ³•å®ç°

#### 3.5.1 adjustWindowSizeAndBatchSize

```java
/**
 * åŠ¨æ€è°ƒæ•´çª—å£å¤§å°å’Œå‹ç¼©æ‰¹æ¬¡å¤§å°
 * æ ¹æ® totalSteps åŠ¨æ€è°ƒæ•´å‚æ•°
 */
private void adjustWindowSizeAndBatchSize() {
    // æ ¹æ® totalSteps åŠ¨æ€è°ƒæ•´ windowSize
    if (totalSteps <= 10) {
        windowSize = 5;
    } else if (totalSteps <= 20) {
        windowSize = 8;
    } else if (totalSteps <= 50) {
        windowSize = 10;
    } else {
        windowSize = 12;  // ä¸Šé™
    }
    
    // æ ¹æ® totalSteps åŠ¨æ€è°ƒæ•´ compressionBatchSize
    if (totalSteps <= 10) {
        compressionBatchSize = 2;
    } else if (totalSteps <= 20) {
        compressionBatchSize = 3;
    } else if (totalSteps <= 50) {
        compressionBatchSize = 4;
    } else {
        compressionBatchSize = 5;  // ä¸Šé™
    }
}
```

---

#### 3.5.2 shouldCompress

```java
/**
 * åˆ¤æ–­æ˜¯å¦éœ€è¦å‹ç¼©å†å²è®°å½•
 * 
 * @return true å¦‚æœéœ€è¦å‹ç¼©ï¼Œfalse å¦åˆ™
 */
private boolean shouldCompress() {
    // æ£€æŸ¥è¯¦ç»†è®°å½•æ•°é‡æ˜¯å¦è¶…è¿‡çª—å£å¤§å°
    return recentDetailedHistory.size() > windowSize;
}
```

---

#### 3.5.3 extractField â€”â€” private è¢« extractKeyInfo è°ƒç”¨

```java
/**
 * ä»æ–‡æœ¬ä¸­æå–å­—æ®µå†…å®¹
 * 
 * @param text æ–‡æœ¬å†…å®¹
 * @param fieldMarker å­—æ®µæ ‡è®°ï¼ˆå¦‚ "**ä»»åŠ¡çŠ¶æ€:**"ï¼‰
 * @return å­—æ®µå†…å®¹ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
 */
private String extractField(String text, String fieldMarker) {
    if (text == null || text.isEmpty()) {
        return null;
    }
    
    // æŸ¥æ‰¾å­—æ®µæ ‡è®°çš„ä½ç½®
    int markerIndex = text.indexOf(fieldMarker);
    if (markerIndex == -1) {
        return null;  // æœªæ‰¾åˆ°å­—æ®µæ ‡è®°
    }
    
    // æ‰¾åˆ°å­—æ®µå†…å®¹çš„èµ·å§‹ä½ç½®ï¼ˆæ ‡è®°åï¼‰
    int contentStart = markerIndex + fieldMarker.length();
    
    // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå­—æ®µæ ‡è®°çš„ä½ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    int nextMarkerIndex = text.indexOf("**", contentStart);
    
    // æå–å­—æ®µå†…å®¹
    String fieldContent;
    if (nextMarkerIndex != -1) {
        // æœ‰ä¸‹ä¸€ä¸ªå­—æ®µï¼Œæå–åˆ°ä¸‹ä¸€ä¸ªå­—æ®µä¹‹å‰
        fieldContent = text.substring(contentStart, nextMarkerIndex);
    } else {
        // æ²¡æœ‰ä¸‹ä¸€ä¸ªå­—æ®µï¼Œæå–åˆ°æ–‡æœ¬ç»“æŸ
        fieldContent = text.substring(contentStart);
    }
    
    // å»é™¤é¦–å°¾ç©ºç™½å­—ç¬¦
    return fieldContent.trim();
}
```

---

#### 3.5.4 truncate â€”â€” private è¢« extractKeyInfo è°ƒç”¨

```java
/**
 * æˆªæ–­æ–‡æœ¬åˆ°æŒ‡å®šé•¿åº¦
 * 
 * @param text æ–‡æœ¬å†…å®¹
 * @param maxLength æœ€å¤§é•¿åº¦
 * @return æˆªæ–­åçš„æ–‡æœ¬
 */
private String truncate(String text, int maxLength) {
    if (text == null || text.isEmpty()) {
        return "";
    }
    
    if (text.length() <= maxLength) {
        return text;
    }
    
    // æˆªæ–­åˆ°æŒ‡å®šé•¿åº¦ï¼Œå¹¶æ·»åŠ çœç•¥å·
    return text.substring(0, maxLength) + "...";
}
```

---

#### 3.5.5 checkAndCompressSummaryHistory â€”â€” private è¢« compressHistory  è°ƒç”¨

```java
/**
 * æ£€æŸ¥æ‘˜è¦å±‚é•¿åº¦ï¼Œå¦‚æœè¶…è¿‡æœ€å¤§é•¿åº¦åˆ™è¿›ä¸€æ­¥å‹ç¼©
 */
private void checkAndCompressSummaryHistory() {
    // è®¡ç®—æ‘˜è¦å±‚çš„æ€»é•¿åº¦
    int totalLength = 0;
    for (SummaryRecord record : summaryHistory) {
        totalLength += record.getSummary().length();
    }
    
    // å¦‚æœè¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œç§»é™¤æœ€æ—§çš„æ‘˜è¦
    if (totalLength > maxSummaryLength) {
        while (totalLength > maxSummaryLength && !summaryHistory.isEmpty()) {
            SummaryRecord oldest = summaryHistory.remove(0);
            totalLength -= oldest.getSummary().length();
        }
    }
}
```

---

## å››ã€æ•°æ®ç»“æ„å®šä¹‰

### 4.1 StepRecord ç±»

```java
package com.chuppch.domain.agent.service.executor.auto.history;

import lombok.Data;
import java.io.Serializable;

/**
 * æ­¥éª¤è®°å½•
 * è¡¨ç¤ºå•æ­¥æ‰§è¡Œçš„å®Œæ•´è®°å½•
 */
@Data
public class StepRecord implements Serializable {
    
    /** æ­¥æ•° */
    private int stepNumber;
    
    /** åˆ†æé˜¶æ®µçš„ç»“æœ */
    private String analysisResult;
    
    /** æ‰§è¡Œé˜¶æ®µçš„ç»“æœ */
    private String executionResult;
    
    /** ç›‘ç£é˜¶æ®µçš„ç»“æœ */
    private String supervisionResult;
    
    /** æ‰§è¡Œæ—¶é—´æˆ³ */
    private long timestamp;
    
    /** æ ¼å¼åŒ–åçš„å®Œæ•´è®°å½• */
    private String stepSummary;
}
```

---

### 4.2 SummaryRecord ç±»

```java
package com.chuppch.domain.agent.service.executor.auto.history;

import lombok.Data;
import java.io.Serializable;

/**
 * æ‘˜è¦è®°å½•
 * è¡¨ç¤ºå‹ç¼©åçš„æ‘˜è¦ä¿¡æ¯
 */
@Data
public class SummaryRecord implements Serializable {
    
    /** èµ·å§‹æ­¥æ•° */
    private int startStep;
    
    /** ç»“æŸæ­¥æ•° */
    private int endStep;
    
    /** æ‘˜è¦å†…å®¹ */
    private String summary;
    
    /** ç”Ÿæˆæ—¶é—´æˆ³ */
    private long timestamp;
}
```

---

## äº”ã€ä½¿ç”¨ç¤ºä¾‹

### 5.1 åŸºæœ¬ä½¿ç”¨

```java
// åˆå§‹åŒ– ExecutionHistoryManager
ExecutionHistoryManager historyManager = new ExecutionHistoryManager();

// è¿½åŠ æ­¥éª¤
historyManager.appendStep(
    1, 
    "åˆ†æç»“æœ...", 
    "æ‰§è¡Œç»“æœ...", 
    "ç›‘ç£ç»“æœ..."
);

// è·å–å†å²è®°å½•
String history = historyManager.getHistory();
```

---

### 5.2 åœ¨ AutoAgentTest ä¸­çš„é›†æˆ

```java
// ========== ä¿®æ”¹ç‚¹1: åˆå§‹åŒ– ==========
// åŸä»£ç 
StringBuilder executionHistory = new StringBuilder();

// ä¿®æ”¹å
ExecutionHistoryManager executionHistoryManager = new ExecutionHistoryManager();

// ========== ä¿®æ”¹ç‚¹2: è·å–å†å²è®°å½•ï¼ˆåˆ†æå™¨æç¤ºè¯ï¼‰ ==========
// åŸä»£ç 
executionHistory.length() > 0 ? executionHistory.toString() : "[é¦–æ¬¡æ‰§è¡Œ]"

// ä¿®æ”¹å
executionHistoryManager.getHistory()

// ========== ä¿®æ”¹ç‚¹3: è¿½åŠ å†å²è®°å½• ==========
// åŸä»£ç 
executionHistory.append(stepSummary);

// ä¿®æ”¹å
executionHistoryManager.appendStep(step, analysisResult, executionResult, supervisionResult);

// ========== ä¿®æ”¹ç‚¹4: è·å–å†å²è®°å½•ï¼ˆæœ€ç»ˆæ€»ç»“æŠ¥å‘Šï¼‰ ==========
// åŸä»£ç 
executionHistory.toString()

// ä¿®æ”¹å
executionHistoryManager.getHistory()
```

---

## å…­ã€é›†æˆæŒ‡å—

### 6.1 ä¿®æ”¹æ¸…å•

**éœ€è¦ä¿®æ”¹çš„ä½ç½®ï¼š**

1. **ç¬¬445è¡Œï¼šåˆå§‹åŒ–**
   ```java
   ExecutionHistoryManager executionHistoryManager = new ExecutionHistoryManager();
   ```

2. **ç¬¬615è¡Œï¼šè·å–å†å²è®°å½•ï¼ˆåˆ†æå™¨æç¤ºè¯ï¼‰**
   ```java
   executionHistoryManager.getHistory()
   ```

3. **ç¬¬697è¡Œï¼šè¿½åŠ å†å²è®°å½•**
   ```java
   executionHistoryManager.appendStep(step, analysisResult, executionResult, supervisionResult);
   ```

4. **ç¬¬707è¡Œï¼šå¼‚å¸¸å¤„ç†ä¸­çš„è¿½åŠ **
   ```java
   executionHistoryManager.appendStep(step, "å¼‚å¸¸", "æ‰§è¡Œå¼‚å¸¸", e.getMessage());
   ```

5. **ç¬¬732è¡Œï¼šè·å–å†å²è®°å½•ï¼ˆæœ€ç»ˆæ€»ç»“æŠ¥å‘Šï¼‰**
   ```java
   executionHistoryManager.getHistory()
   ```

6. **ç¬¬714è¡Œï¼šlogExecutionSummary æ–¹æ³•è°ƒç”¨**
   ```java
   // éœ€è¦ä¿®æ”¹æ–¹æ³•ç­¾åï¼Œä¼ å…¥å®é™…æ­¥æ•°
   logExecutionSummary(maxSteps, actualSteps, isCompleted);
   ```

---

### 6.2 ä¿®æ”¹ logExecutionSummary æ–¹æ³•

```java
/**
 * è¾“å‡ºæ‰§è¡Œæ€»ç»“ä¿¡æ¯
 * 
 * @param maxSteps æœ€å¤§æ­¥æ•°
 * @param actualSteps å®é™…æ‰§è¡Œæ­¥æ•°ï¼ˆç”±è°ƒç”¨æ–¹ä¼ å…¥ï¼Œä¸éœ€è¦ä» ExecutionHistoryManager è·å–ï¼‰
 * @param isCompleted æ˜¯å¦å®Œæˆ
 */
private void logExecutionSummary(int maxSteps, int actualSteps, boolean isCompleted) {
    log.info("\nğŸ“Š === åŠ¨æ€å¤šè½®æ‰§è¡Œæ€»ç»“ ====");
    
    log.info("ğŸ“ˆ æ€»æ‰§è¡Œæ­¥æ•°: {} æ­¥", actualSteps);
    
    if (isCompleted) {
        log.info("âœ… ä»»åŠ¡å®ŒæˆçŠ¶æ€: å·²å®Œæˆ");
    } else {
        log.info("â¸ï¸ ä»»åŠ¡å®ŒæˆçŠ¶æ€: æœªå®Œæˆï¼ˆè¾¾åˆ°æœ€å¤§æ­¥æ•°é™åˆ¶ï¼‰");
    }
    
    // è®¡ç®—æ‰§è¡Œæ•ˆç‡
    double efficiency = isCompleted ? 100.0 : (double) actualSteps / maxSteps * 100;
    log.info("ğŸ“Š æ‰§è¡Œæ•ˆç‡: {:.1f}%", efficiency);
}
```

**è¯´æ˜ï¼š**
- ä¸éœ€è¦æ·»åŠ  `getTotalSteps()` æ–¹æ³•
- è°ƒç”¨æ–¹ï¼ˆAutoAgentTestï¼‰çš„å¾ªç¯ä¸­å·²æœ‰ `step` å˜é‡ï¼Œå¯ä»¥ç›´æ¥ä¼ å…¥
- ç¬¦åˆæœ€å°æ¥å£åŸåˆ™ï¼Œä¸æš´éœ²ä¸å¿…è¦çš„å†…éƒ¨çŠ¶æ€

---

### 6.3 å…³äºæ€»æ­¥æ•°çš„è¯´æ˜

**ä¸éœ€è¦æ·»åŠ  `getTotalSteps()` æ–¹æ³•**

**åŸå› ï¼š**
1. **è®¾è®¡æ–‡æ¡£ä¸­æœªå®šä¹‰**ï¼šåŸå§‹è®¾è®¡æ–‡æ¡£ï¼ˆ`æ»‘åŠ¨çª—å£å¯¹è±¡è®¾è®¡.md`ï¼‰ä¸­æœªæåˆ°æ­¤æ–¹æ³•
2. **è°ƒç”¨æ–¹å·²æœ‰æ­¥æ•°ä¿¡æ¯**ï¼šAutoAgentTest çš„å¾ªç¯ä¸­å·²æœ‰ `step` å˜é‡ï¼ŒçŸ¥é“å½“å‰æ­¥æ•°
3. **ç¬¦åˆå°è£…åŸåˆ™**ï¼š`totalSteps` æ˜¯å†…éƒ¨å­—æ®µï¼Œç”¨äºå†…éƒ¨é€»è¾‘ï¼ˆåŠ¨æ€è°ƒæ•´å‚æ•°ï¼‰ï¼Œä¸éœ€è¦å¯¹å¤–æš´éœ²
4. **ä¸šåŠ¡éœ€æ±‚å¯é€šè¿‡å‚æ•°ä¼ é€’æ»¡è¶³**ï¼š`logExecutionSummary` æ–¹æ³•å¯ä»¥é€šè¿‡å‚æ•°æ¥æ”¶æ­¥æ•°ï¼Œæ— éœ€ä» `ExecutionHistoryManager` è·å–

**å®ç°æ–¹å¼ï¼š**
- åœ¨è°ƒç”¨ `logExecutionSummary` æ—¶ï¼Œç›´æ¥ä¼ å…¥å¾ªç¯å˜é‡ `step` ä½œä¸ºå®é™…æ­¥æ•°
- è¿™æ ·æ—¢æ»¡è¶³äº†ä¸šåŠ¡éœ€æ±‚ï¼Œåˆéµå¾ªäº†è®¾è®¡æ–‡æ¡£çš„çº¦æŸ

---

## ä¸ƒã€æµ‹è¯•å»ºè®®

### 7.1 å•å…ƒæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹ï¼š**

1. **æµ‹è¯• appendStep æ–¹æ³•**
   - æµ‹è¯•è¿½åŠ å•æ¡è®°å½•
   - æµ‹è¯•è¿½åŠ å¤šæ¡è®°å½•
   - æµ‹è¯•è‡ªåŠ¨å‹ç¼©è§¦å‘

2. **æµ‹è¯• getHistory æ–¹æ³•**
   - æµ‹è¯•é¦–æ¬¡æ‰§è¡Œè¿”å› "[é¦–æ¬¡æ‰§è¡Œ]"
   - æµ‹è¯•è¿”å›æ‘˜è¦ + è¯¦ç»†è®°å½•
   - æµ‹è¯•æ ¼å¼åŒ–è¾“å‡º

3. **æµ‹è¯• compressHistory æ–¹æ³•**
   - æµ‹è¯•å‹ç¼©é€»è¾‘
   - æµ‹è¯•æ‘˜è¦ç”Ÿæˆ
   - æµ‹è¯•è®°å½•ç§»é™¤

4. **æµ‹è¯• extractKeyInfo æ–¹æ³•**
   - æµ‹è¯•å­—æ®µæå–
   - æµ‹è¯•è¾¹ç•Œæƒ…å†µ
   - æµ‹è¯•æ ¼å¼åŒ–è¾“å‡º

---

### 7.2 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯ï¼š**

1. **å¤šæ­¥æ‰§è¡Œæµ‹è¯•**
   - æ‰§è¡Œ 20 æ­¥ï¼ŒéªŒè¯å‹ç¼©æœºåˆ¶
   - éªŒè¯å†å²è®°å½•é•¿åº¦æ§åˆ¶
   - éªŒè¯ token æ¶ˆè€—å‡å°‘

2. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**
   - æµ‹è¯•é¦–æ¬¡æ‰§è¡Œ
   - æµ‹è¯•å•æ­¥æ‰§è¡Œ
   - æµ‹è¯•å¤§é‡æ­¥æ•°æ‰§è¡Œ

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 8.1 å†…å­˜ä¼˜åŒ–

- ä½¿ç”¨ `Deque` å’Œ `List` ç®¡ç†è®°å½•ï¼Œé¿å…é¢‘ç¹æ‰©å®¹
- åŠæ—¶æ¸…ç†è¿‡æœŸçš„æ‘˜è¦è®°å½•
- æ§åˆ¶æ‘˜è¦å±‚æœ€å¤§é•¿åº¦

### 8.2 Token ä¼˜åŒ–

- é€šè¿‡æ»‘åŠ¨çª—å£æ§åˆ¶è¯¦ç»†è®°å½•æ•°é‡
- é€šè¿‡å‹ç¼©æœºåˆ¶å‡å°‘å†å²è®°å½•é•¿åº¦
- é¢„è®¡å¯ä»¥å‡å°‘ 50-70% çš„ token æ¶ˆè€—

---

## ä¹ã€æ‰©å±•å»ºè®®

### 9.1 æœªæ¥æ‰©å±•

- æ”¯æŒå¼‚å¸¸æ­¥éª¤çš„ç‰¹æ®Šå¤„ç†
- æ”¯æŒä¸åŒå‹ç¼©ç­–ç•¥ï¼ˆAI æ‘˜è¦ã€ç»“æ„åŒ–å‹ç¼©ï¼‰
- æ”¯æŒå†å²è®°å½•çš„æŒä¹…åŒ–å­˜å‚¨
- æ”¯æŒå†å²è®°å½•çš„æŸ¥è¯¢å’Œæ£€ç´¢

---

## åã€æ€»ç»“

### 10.1 æ ¸å¿ƒä¼˜åŠ¿

1. **ä½ä¾µå…¥æ€§**ï¼šæœ€å°åŒ–å¯¹ç°æœ‰ä»£ç çš„ä¿®æ”¹
2. **è‡ªåŠ¨åŒ–**ï¼šå‹ç¼©æœºåˆ¶è‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
3. **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®ä»»åŠ¡è§„æ¨¡åŠ¨æ€è°ƒæ•´å‚æ•°
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæœ‰æ•ˆæ§åˆ¶ token æ¶ˆè€—

### 10.2 å®ç°è¦ç‚¹

1. ä½¿ç”¨ `Deque` ç®¡ç†è¯¦ç»†è®°å½•ï¼Œæ”¯æŒé«˜æ•ˆçš„å¤´éƒ¨ç§»é™¤
2. ä½¿ç”¨ `List` ç®¡ç†æ‘˜è¦è®°å½•ï¼Œæ”¯æŒçµæ´»çš„æŸ¥è¯¢å’Œæ“ä½œ
3. æå–å…³é”®ä¿¡æ¯æ—¶å¤„ç†è¾¹ç•Œæƒ…å†µï¼Œç¡®ä¿ç¨³å®šæ€§
4. åŠ¨æ€è°ƒæ•´å‚æ•°ï¼Œå¹³è¡¡æ€§èƒ½å’Œæ•ˆæœ

---

## é™„å½•ï¼šå®Œæ•´ç±»ç»“æ„

```java
package com.chuppch.domain.agent.service.executor.auto.history;

import java.util.*;

public class ExecutionHistoryManager {
    // å­—æ®µå®šä¹‰
    private final Deque<StepRecord> recentDetailedHistory;
    private final List<SummaryRecord> summaryHistory;
    private int windowSize;
    private int compressionBatchSize;
    private int totalSteps;
    private final int maxSummaryLength;
    
    // æ„é€ å‡½æ•°
    public ExecutionHistoryManager() { ... }
    public ExecutionHistoryManager(int windowSize, int compressionBatchSize, int maxSummaryLength) { ... }
    
    // æ ¸å¿ƒæ–¹æ³•
    public void appendStep(int stepNumber, String analysisResult, String executionResult, String supervisionResult) { ... }
    public String getHistory() { ... }
    
    // å†…éƒ¨æ–¹æ³•
    private void compressHistory() { ... }
    private String extractKeyInfo(StepRecord record) { ... }
    private void adjustWindowSizeAndBatchSize() { ... }
    private boolean shouldCompress() { ... }
    private String extractField(String text, String fieldMarker) { ... }
    private String truncate(String text, int maxLength) { ... }
    private void checkAndCompressSummaryHistory() { ... }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2025-01-03  
**ä½œè€…ï¼š** Chuppch
